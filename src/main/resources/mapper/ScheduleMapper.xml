<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kcc.springmini.domain.schedule.repository.mapper.ScheduleMapper">
    <insert id="save" parameterType="ScheduleVO">
        insert into MeetUpSchedule(schedule_id, meet_up_id, member_id, title, content, location, person, deadline, appointment_time, created_at)
        values(SEQ_MEETUPSCHEDULE.nextval, #{meet_up_id}, #{member_id}, #{title}, #{content}, #{location}, #{person},
               TO_TIMESTAMP(#{deadline}, 'YYYY-MM-DD HH24:MI:SS'),
               TO_TIMESTAMP(#{appointment_time}, 'YYYY-MM-DD HH24:MI:SS'), systimestamp)
    </insert>

    <!-- 모임 일정 맴버 생성 (참가하기) -->
    <!-- 선착순 참가를 위한 비관 LOCK -->
    <select id="checkAvailableSpace" parameterType="long" resultType="int">
        SELECT CASE
                   WHEN person > (SELECT COUNT(*) FROM SCHEDULEBELONGMEMBER WHERE schedule_id = #{scheduleId})
                       THEN 1
                   ELSE 0
                   END AS isAvailable
        FROM MeetUpSchedule
        WHERE schedule_id = #{scheduleId}
            FOR UPDATE;
    </select>

    <!-- 모임 일정 참가 인원 증가 -->
    <update id="updateSchedulePerson" parameterType="long">
        update MeetUpSchedule
        set person = person + 1
        where schedule_id = #{scheduleId}
    </update>

    <!-- 모임 일정 참가인원 삽입 -->
    <insert id="saveMember" parameterType="map">
        insert into SCHEDULEBELONGMEMBER(meet_up_id, schedule_id, member_id)
        values(#{meetupId}, #{scheduleId}, #{memberId})
    </insert>


    <delete id="delete" parameterType="long">
        delete from MeetUpSchedule where schedule_id = #{id}
    </delete>

    <select id="findById" parameterType="long" resultType="ScheduleResponseDto">
        select ms.title, ms.content, ms.appointment_time, ms.person, ms.deadline, m.nickname,
               (select count(*) from SCHEDULEBELONGMEMBER sbm where sbm.schedule_id = ms.schedule_id) as accept_count
        from MeetUpSchedule ms
        inner join Member m on ms.member_id = m.member_id
        where ms.schedule_id = #{id}
    </select>

    <select id="findAll" parameterType="map" resultType="ScheduleListResponseDto">
        <![CDATA[
        select inline_ms.title, inline_ms.content, inline_ms.person,
               inline_ms.deadline, inline_ms.appointment_time, inline_ms.schedule_id
        from
            (
                select ms.title, ms.content, ms.person,
                       ms.deadline, ms.appointment_time, schedule_id, ROWNUM rnum
                from (
                    select *
                    from MeetUpSchedule ms
                    where ms.meet_up_id = #{meetUpId}
                    AND ms.deadline >= systimestamp
                    order by created_at asc
                ) ms
                where ROWNUM <= #{limit} + #{offset}
            ) inline_ms
        where rnum > #{offset}
        ]]>
    </select>

    <select id="count" parameterType="long" resultType="long">
        select count(*)
        from MeetUpSchedule
        where meet_up_id = #{meetUpId}
        AND deadline >= systimestamp
    </select>
</mapper>
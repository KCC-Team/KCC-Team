<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kcc.springmini.domain.schedule.repository.mapper.ScheduleMapper">
    <insert id="save" parameterType="ScheduleVO">
        insert into MeetUpSchedule(schedule_id, meet_up_id, member_id, title, content, location, person, deadline, appointment_time, created_at)
        values(SEQ_MEETUPSCHEDULE.nextval, #{meet_up_id}, #{member_id}, #{title}, #{content}, #{location}, #{person},
               TO_TIMESTAMP(#{deadline}, 'YYYY-MM-DD HH24:MI:SS'),
               TO_TIMESTAMP(#{appointment_time}, 'YYYY-MM-DD HH24:MI:SS'), systimestamp)
    </insert>

    <delete id="delete" parameterType="long">
        delete from MeetUpSchedule where schedule_id = #{id}
    </delete>

    <select id="findById" parameterType="long" resultType="ScheduleVO">
        select * from MeetUpSchedule where schedule_id = #{id}
    </select>

    <select id="findAll" parameterType="map" resultType="ScheduleVO">
        <![CDATA[
        select inline_ms.schedule_id, inline_ms.meet_up_id, inline_ms.member_id,
               inline_ms.title, inline_ms.content, inline_ms.location, inline_ms.person,
               inline_ms.deadline, inline_ms.appointment_time
        from
            (
                select ms.schedule_id, ms.meet_up_id, ms.member_id,
                       ms.title, ms.content, ms.location, ms.person,
                       ms.deadline, ms.appointment_time, ROWNUM rnum
                from (
                    select *
                    from MeetUpSchedule ms
                    where ms.meet_up_id = #{meetUpId}
                    AND ms.deadline >= systimestamp
                    order by created_at desc
                ) ms
                where ROWNUM <= #{limit} + #{offset}
            ) inline_ms
        where rnum > #{offset}
        ]]>
    </select>

    <select id="count" parameterType="long" resultType="long">
        select count(*)
        from MeetUpSchedule
        where meet_up_id = #{meetUpId}
        AND deadline >= systimestamp
    </select>
</mapper>